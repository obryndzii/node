name: master-CI
on:
  push:
    branches: [ main ]
  pull_request:
    branches:
      - 'main'
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v2
#      -
#        name: Docker meta
#        id: meta
#        uses: docker/metadata-action@v3
#        with:
#          images: ${{ secrets.ECR_NODE }}
      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v1
        with:
          role-to-assume: arn:aws:iam::234104157315:role/GitHubOIDC-Role-1G5XF22DVY7TS
          aws-region: eu-central-1
      - name: Check role
        run: |
          aws sts get-caller-identity 
      - name: Login to ECR
        uses: docker/login-action@v1
        with:
          registry: ${{ secrets.ECR_NODE }}
          username: ${{ secrets.ECR_ACCESS_KEY_ID }}
          password: ${{ secrets.ECR_SECRET_ACCESS_KEY }}
      -
        name: Build and push
        uses: docker/build-push-action@v2
        with:
          context: .
          push: true
          tags: |
            ${{ secrets.ECR_NODE }}:latest
            ${{ secrets.ECR_NODE }}:1.0.0
#      - name: 'Deploy'
#        uses: 'deliverybot/helm@v1'
#        with:
#          # Task remove means to remove the helm release.
#          task: 'remove'
#          release: 'review-myapp'
#          version: '${{ github.sha }}'
#          track: 'stable'
#          chart: 'node'
#          namespace: 'prod'
#          token: '${{ github.TOKEN }}'
#        env:
#          KUBECONFIG_FILE: '${{ secrets.KUBECONFIG }}'
#      - uses: actions/checkout@v2
#        with:
#          repository: 'obryndzii/btt-helm-charts'
#          ref: 'refs/heads/master'
#          path: 'charts'
#          token: ${{ secrets.PAT }}
#      - uses: actions/checkout@v2
#        with:
#          repository: 'obryndzii/btt-docker-images'
#          ref: 'refs/heads/master'
#          path: 'images'
#          token: ${{ secrets.PAT }}
#      - name: Check
#        run: |
#          pwd
#          helm version
#
